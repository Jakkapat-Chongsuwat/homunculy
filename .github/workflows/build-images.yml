# =============================================================================
# Build and Push Container Images
# =============================================================================
# Triggers: Push to main, manual dispatch
# Purpose: Build Docker images and push to Azure Container Registry
# =============================================================================

name: Build Images

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - homunculy
          - chat-client
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

  push:
    branches: [main]
    paths:
      - 'homunculy/**'
      - 'chat-client/**'
      - '.github/workflows/build-images.yml'

env:
  REGISTRY_NAME: acrhomunculy${{ github.event.inputs.environment || 'dev' }}

permissions:
  id-token: write
  contents: read

jobs:
  # ---------------------------------------------------------------------------
  # Detect Changes
  # ---------------------------------------------------------------------------
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      homunculy: ${{ steps.filter.outputs.homunculy }}
      chat-client: ${{ steps.filter.outputs.chat-client }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Path Filter
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            homunculy:
              - 'homunculy/**'
            chat-client:
              - 'chat-client/**'

  # ---------------------------------------------------------------------------
  # Build Homunculy (Python FastAPI)
  # ---------------------------------------------------------------------------
  build-homunculy:
    name: Build Homunculy
    runs-on: ubuntu-latest
    needs: changes
    if: |
      needs.changes.outputs.homunculy == 'true' || 
      github.event.inputs.service == 'all' || 
      github.event.inputs.service == 'homunculy'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        run: |
          az acr login --name ${{ env.REGISTRY_NAME }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY_NAME }}.azurecr.io/homunculy-app
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and Push
        uses: docker/build-push-action@v6
        with:
          context: ./homunculy
          file: ./homunculy/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Image Summary
        run: |
          echo "## ðŸ³ Homunculy Image Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Build Chat Client (Blazor Server)
  # ---------------------------------------------------------------------------
  build-chat-client:
    name: Build Chat Client
    runs-on: ubuntu-latest
    needs: changes
    if: |
      needs.changes.outputs.chat-client == 'true' || 
      github.event.inputs.service == 'all' || 
      github.event.inputs.service == 'chat-client'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        run: |
          az acr login --name ${{ env.REGISTRY_NAME }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY_NAME }}.azurecr.io/chat-client
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and Push
        uses: docker/build-push-action@v6
        with:
          context: ./chat-client
          file: ./chat-client/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            ASPNETCORE_ENVIRONMENT=Production

      - name: Image Summary
        run: |
          echo "## ðŸ³ Chat Client Image Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
