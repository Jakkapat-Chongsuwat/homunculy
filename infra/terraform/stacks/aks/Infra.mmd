flowchart LR
    %% AKS stack connectivity (focus: Argo CD access path)
    %% Goal: readable layout with minimal crossing lines

    %% Outside entrypoints
    USER["ğŸ§‘â€ğŸ’» Browser"]

    subgraph Azure["Azure Subscription"]
        RG["ğŸ“¦ Resource Group<br/>rg-homunculy-aks-ENV"]
        Auth["ğŸ” GitHub Actions<br/>OIDC"]

        %% Public entrypoint is provisioned in Azure, but is visually outside the cluster
        PUBIP["ğŸŒ Public IP<br/>(AKS Web App Routing)"]

        subgraph Network["ğŸŒ Network"]
            VNET["VNet<br/>AKS subnet + DB subnet + Private EP subnet"]
            NSG["Network Security Group<br/>HTTP/HTTPS rules"]
            NSG -. "protects" .-> VNET

            subgraph DNS["ğŸ” DNS (in VNet)"]
                AZDNS["Azure-provided DNS<br/>168.63.129.16"]
                PDNS["Private DNS Zone<br/>privatelink.postgres.database.azure.com"]
                PDNS -. "linked to VNet" .-> VNET
                AZDNS -->|"resolves private zones"| PDNS
            end
        end

        subgraph Storage["ğŸ“¦ Storage"]
            ACR["Container Registry (ACR)"]
        end

        subgraph Data["ğŸ’¾ Data"]
            DB["PostgreSQL"]
            KV["Key Vault"]
            PE["Private Endpoint<br/>(DB)"]
        end

        subgraph Monitoring["ğŸ“Š Monitoring"]
            LAW["Log Analytics"]
        end

        %% Cluster contains workloads (including Argo CD)
        subgraph AKS["ğŸ–¥ï¸ AKS Cluster"]
            NODES["Node pools<br/>system + user"]

            PODS["Pods / Workloads"]
            COREDNS["CoreDNS (cluster DNS)"]

            subgraph Ingress["Ingress (Web App Routing)"]
                IC["Ingress Controller (nginx)<br/>webapprouting.kubernetes.azure.com"]
                INGR["Ingress Rule<br/>/argocd â†’ argocd-server"]
                CHAT["Ingress Rule<br/>/homunculy-chat â†’ chat-client"]
                IC --> INGR
                IC --> CHAT
            end

            subgraph GitOps["ğŸš€ GitOps (in-cluster)"]
                ARGOCD["Argo CD<br/>API/UI server"]
            end

            subgraph Apps["ğŸ§© Apps (in-cluster)"]
                CHATCLIENT["Chat Client<br/>web"]
            end

            INGR -->|"routes"| ARGOCD
            CHAT -->|"routes"| CHATCLIENT

            %% DNS resolution path for DB connectivity
            PODS -->|"DNS query"| COREDNS -->|"forwards"| AZDNS
        end
    end

    %% Public access path (outside â†’ Azure â†’ cluster)
    USER -->|"GET /argocd"| PUBIP --> IC
    USER -->|"GET /homunculy-chat"| PUBIP --> IC

    %% Core connectivity
    VNET -->|"hosts"| AKS
    VNET -->|"private routing"| PE --> DB
    AKS -->|"pulls images"| ACR
    AKS -->|"reads secrets"| KV
    PODS -->|"connects (TCP 5432)"| PE
    AKS -->|"sends logs"| LAW

    %% CI/CD connectivity
    Auth -->|"push images"| ACR
    Auth -->|"sync apps"| ARGOCD