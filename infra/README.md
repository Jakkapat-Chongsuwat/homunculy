# ðŸ° Homunculy Infrastructure

> **GitOps Kingdom**: Where Terraform builds the castle, and ArgoCD guards the gates.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ðŸ° HOMUNCULY INFRASTRUCTURE KINGDOM                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                          â”‚
â”‚    ðŸ‘¨â€ðŸ’» Developer                                                                          â”‚
â”‚        â”‚                                                                                 â”‚
â”‚        â”‚ git push                                                                        â”‚
â”‚        â–¼                                                                                 â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚  ðŸ“š GITHUB CITADEL                                                                â”‚ â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚ â”‚
â”‚    â”‚  â”‚ ðŸ”§ Terraform   â”‚    â”‚ ðŸ³ Dockerfiles â”‚    â”‚ â˜¸ï¸  Kustomize   â”‚                   â”‚ â”‚
â”‚    â”‚  â”‚    /infra      â”‚    â”‚   /services    â”‚    â”‚   /k8s         â”‚                   â”‚ â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚               â”‚                     â”‚                     â”‚                              â”‚
â”‚               â–¼                     â–¼                     â”‚                              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                              â”‚
â”‚    â”‚  âš™ï¸  GITHUB ACTIONS FORGE                          â”‚ â”‚                              â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚                              â”‚
â”‚    â”‚  â”‚ terraform-   â”‚    â”‚ build-       â”‚              â”‚ â”‚                              â”‚
â”‚    â”‚  â”‚ deploy.yml   â”‚    â”‚ deploy.yaml  â”‚              â”‚ â”‚                              â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚                              â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                              â”‚
â”‚              â”‚                   â”‚                        â”‚                              â”‚
â”‚              â–¼                   â–¼                        â”‚                              â”‚
â”‚    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                    â˜ï¸  AZURE CLOUD REALM                  â”‚                              â”‚
â”‚    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                          â”‚                              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚                              â”‚
â”‚    â”‚ ðŸ—ï¸  Terraform     â”‚    â”‚ ðŸ“¦ ACR Registry  â”‚          â”‚                              â”‚
â”‚    â”‚  Creates:        â”‚    â”‚                  â”‚          â”‚                              â”‚
â”‚    â”‚  â€¢ VNet          â”‚â”€â”€â”€â–¶â”‚  â€¢ homunculy     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚    â”‚  â€¢ AKS           â”‚    â”‚  â€¢ management    â”‚                                         â”‚
â”‚    â”‚  â€¢ PostgreSQL    â”‚    â”‚  â€¢ rag-service   â”‚                                         â”‚
â”‚    â”‚  â€¢ Key Vault     â”‚    â”‚  â€¢ chat-client   â”‚                                         â”‚
â”‚    â”‚  â€¢ Monitoring    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚                                                   â”‚
â”‚              â”‚                      â”‚                                                   â”‚
â”‚              â–¼                      â–¼                                                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚    â”‚  â˜¸ï¸  AKS KUBERNETES FORTRESS  (aks-homunculy-prod)                               â”‚  â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚    â”‚  â”‚  ðŸ”„ ARGOCD WATCHTOWER                                                    â”‚    â”‚  â”‚
â”‚    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚    â”‚  â”‚
â”‚    â”‚  â”‚  â”‚ GitOps Sync â”‚  â”‚ Kustomize   â”‚  â”‚ Image       â”‚                       â”‚    â”‚  â”‚
â”‚    â”‚  â”‚  â”‚ Controller  â”‚  â”‚ Build       â”‚  â”‚ Updater     â”‚                       â”‚    â”‚  â”‚
â”‚    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                       â”‚    â”‚  â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚    â”‚            â”‚                â”‚                â”‚                                   â”‚  â”‚
â”‚    â”‚            â–¼                â–¼                â–¼                                   â”‚  â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚    â”‚  â”‚  ðŸ›ï¸  HOMUNCULY NAMESPACE                                                 â”‚    â”‚  â”‚
â”‚    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚    â”‚  â”‚
â”‚    â”‚  â”‚  â”‚ðŸ¤– Homunculyâ”‚ â”‚ðŸ“Š Mgmt Svc â”‚ â”‚ðŸ” RAG Svc  â”‚ â”‚ðŸ’¬ Chat     â”‚             â”‚    â”‚  â”‚
â”‚    â”‚  â”‚  â”‚  (Python)  â”‚ â”‚   (Go)     â”‚ â”‚  (Python)  â”‚ â”‚  (Blazor)  â”‚             â”‚    â”‚  â”‚
â”‚    â”‚  â”‚  â”‚  :8000     â”‚ â”‚   :8080    â”‚ â”‚   :8001    â”‚ â”‚   :8080    â”‚             â”‚    â”‚  â”‚
â”‚    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚    â”‚  â”‚
â”‚    â”‚  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚    â”‚  â”‚
â”‚    â”‚  â”‚                              â”‚                                           â”‚    â”‚  â”‚
â”‚    â”‚  â”‚                              â–¼                                           â”‚    â”‚  â”‚
â”‚    â”‚  â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚    â”‚  â”‚
â”‚    â”‚  â”‚                    â”‚ ðŸšª Ingress      â”‚                                   â”‚    â”‚  â”‚
â”‚    â”‚  â”‚                    â”‚ (App Routing)   â”‚                                   â”‚    â”‚  â”‚
â”‚    â”‚  â”‚                    â”‚ *.homunculy.io  â”‚                                   â”‚    â”‚  â”‚
â”‚    â”‚  â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚    â”‚  â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                     â”‚                                                    â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚    â”‚ ðŸ˜ PostgreSQL    â”‚    â”‚ ðŸ” Key Vault   â”‚    â”‚ ðŸ“Š Log Analytics â”‚                   â”‚
â”‚    â”‚ Flexible Server  â”‚    â”‚ Secrets        â”‚    â”‚ App Insights     â”‚                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                                          â”‚
â”‚    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                     â–¼                                                    â”‚
â”‚                             â˜ï¸  INTERNET                                                 â”‚
â”‚                                     â”‚                                                    â”‚
â”‚                                     â–¼                                                    â”‚
â”‚                               ðŸ‘¥ Users                                                   â”‚
â”‚                        chat.homunculy.io                                                 â”‚
â”‚                        api.homunculy.io                                                  â”‚
â”‚                                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ“ Directory Structure

```
infra/
â”œâ”€â”€ k8s/                    # â˜¸ï¸  Kubernetes GitOps (Kustomize + ArgoCD)
â”‚   â”œâ”€â”€ base/               #    Base manifests (environment-agnostic)
â”‚   â”œâ”€â”€ overlays/           #    Environment overrides (dev/prod)
â”‚   â”œâ”€â”€ infrastructure/     #    ArgoCD sources & configs
â”‚   â””â”€â”€ clusters/           #    Cluster-specific bootstraps
â”‚
â””â”€â”€ terraform/              # ðŸ—ï¸  Infrastructure as Code
    â”œâ”€â”€ stacks/             #    Deployment architectures
    â”‚   â”œâ”€â”€ aks/            #    AKS + full Kubernetes stack
    â”‚   â””â”€â”€ container-apps/ #    Serverless (simpler, cheaper)
    â”œâ”€â”€ modules/            #    Reusable components
    â””â”€â”€ environments/       #    Dev/Prod configurations
```

---

## ðŸš€ Quick Start

### Prerequisites
```bash
# Azure CLI + Terraform
az login
terraform --version  # >= 1.9.0
```

### Deploy AKS (Production)
```bash
cd infra/terraform/stacks/aks

export TF_VAR_subscription_id=$(az account show --query id -o tsv)
export TF_VAR_openai_api_key="sk-..."
export TF_VAR_elevenlabs_api_key="..."

terraform init
terraform plan -var-file=../../environments/prod/aks.tfvars
terraform apply -var-file=../../environments/prod/aks.tfvars
```

### Connect to AKS
```bash
# Get credentials (private cluster - use az aks command invoke)
az aks get-credentials -g rg-homunculy-aks-prod -n aks-homunculy-prod

# Run commands via Azure
az aks command invoke -g rg-homunculy-aks-prod -n aks-homunculy-prod \
  --command "kubectl get pods -n homunculy"
```

### Bootstrap ArgoCD
```bash
# Install ArgoCD
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

# Apply app-of-apps
kubectl apply -f infra/k8s/clusters/prod/
```

---

## ðŸ”‘ GitHub Secrets Required

| Secret | Description |
|--------|-------------|
| `AZURE_CLIENT_ID` | Service Principal App ID |
| `AZURE_TENANT_ID` | Azure Tenant ID |
| `AZURE_SUBSCRIPTION_ID` | Subscription ID |

---

## ðŸ“Š Deployed Resources

| Resource | Name | Purpose |
|----------|------|---------|
| AKS | `aks-homunculy-prod` | Kubernetes cluster |
| ACR | `acrhomunculyprod` | Container images |
| PostgreSQL | `psql-homunculy-prod` | Database |
| Key Vault | `kv-homunculy-prod` | Secrets |
| Log Analytics | `log-homunculy-prod` | Monitoring |

---

## ðŸ§ª Testing

```bash
cd infra/terraform
terraform test                                    # All tests
terraform test -filter=tests/aks.tftest.hcl      # AKS only
```

---

## ðŸ’¥ Destroy

```bash
cd infra/terraform/stacks/aks
terraform destroy -var-file=../../environments/prod/aks.tfvars
```
